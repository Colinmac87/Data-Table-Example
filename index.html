<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piping Thickness Data</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h2 class="left-align">Piping Thickness Data</h2>

    <div class="button-container left-align">
        <button class="maximo-button" onclick="openAddRowModal()">Add New Measurement Row</button>
        <button class="maximo-button" onclick="openCompareModal()">Compare Readings</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>DIAMETER (INCHES)</th>
                    <th>1.50</th>
                    <th>4.00</th>
                    <th>6.00</th>
                    <th>10.00</th>
                    <th>12.00</th>
                    <th>14.00</th>
                    <th>16.00</th>
                    <th>18.00</th>
                    <th>20.00</th>
                    <th>22.00</th>
                    <th>24.00</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Outer Diameter (inches)</td>
                    <td>1.90</td>
                    <td>4.50</td>
                    <td>6.63</td>
                    <td>10.75</td>
                    <td>12.75</td>
                    <td>14.00</td>
                    <td>16.00</td>
                    <td>18.00</td>
                    <td>20.00</td>
                    <td>22.00</td>
                    <td>24.00</td>
                </tr>
                <tr class="nominal-wall-thickness">
                    <td>Nominal Wall Thickness (mm)</td>
                    <td>7.14</td>
                    <td>11.13</td>
                    <td>14.27</td>
                    <td>18.26</td>
                    <td>21.44</td>
                    <td>23.82</td>
                    <td>26.19</td>
                    <td>29.36</td>
                    <td>32.54</td>
                    <td>34.92</td>
                    <td>38.89</td>
                </tr>
                <tr class="section-header">
                    <td colspan="12">Measurements</td>
                </tr>
                <tr>
                    <td>30/10/2015</td>
                    <td class="editable" data-diameter="1.50" data-test-point="TP1">Min: 9.30 mm<br>TP1</td>
                    <td class="editable" data-diameter="4.00">-</td>
                    <td class="editable" data-diameter="6.00">-</td>
                    <td class="editable" data-diameter="10.00">-</td>
                    <td class="editable" data-diameter="12.00">-</td>
                    <td class="editable" data-diameter="14.00">-</td>
                    <td class="editable" data-diameter="16.00">-</td>
                    <td class="editable" data-diameter="18.00">-</td>
                    <td class="editable" data-diameter="20.00">-</td>
                    <td class="editable" data-diameter="22.00">-</td>
                    <td class="editable" data-diameter="24.00">-</td>
                </tr>
                <tr>
                    <td>30/10/2019</td>
                    <td class="editable" data-diameter="1.50">-</td>
                    <td class="editable" data-diameter="4.00" data-test-point="W1">Min: 10.80 mm<br>W1</td>
                    <td class="editable" data-diameter="6.00">-</td>
                    <td class="editable" data-diameter="10.00">-</td>
                    <td class="editable" data-diameter="12.00">-</td>
                    <td class="editable" data-diameter="14.00">-</td>
                    <td class="editable" data-diameter="16.00">-</td>
                    <td class="editable" data-diameter="18.00">-</td>
                    <td class="editable" data-diameter="20.00">-</td>
                    <td class="editable" data-diameter="22.00">-</td>
                    <td class="editable" data-diameter="24.00">-</td>
                </tr>
                <tr>
                    <td>30/10/2022</td>
                    <td class="editable" data-diameter="1.50" data-test-point="TP2">Min: 8.90 mm<br>TP2</td>
                    <td class="editable" data-diameter="4.00">-</td>
                    <td class="editable" data-diameter="6.00" data-test-point="TP3">Min: 12.30 mm<br>TP3</td>
                    <td class="editable" data-diameter="10.00">-</td>
                    <td class="editable" data-diameter="12.00">-</td>
                    <td class="editable" data-diameter="14.00">-</td>
                    <td class="editable" data-diameter="16.00">-</td>
                    <td class="editable" data-diameter="18.00">-</td>
                    <td class="editable" data-diameter="20.00">-</td>
                    <td class="editable" data-diameter="22.00">-</td>
                    <td class="editable" data-diameter="24.00">-</td>
                </tr>
                <tr>
                    <td>30/10/2024</td>
                    <td class="editable" data-diameter="1.50" data-test-point="W2">Min: 4.70 mm<br>W2</td>
                    <td class="editable" data-diameter="4.00">-</td>
                    <td class="editable" data-diameter="6.00">-</td>
                    <td class="editable" data-diameter="10.00" data-test-point="TP4">Min: 11.80 mm<br>TP4</td>
                    <td class="editable" data-diameter="12.00">-</td>
                    <td class="editable" data-diameter="14.00">-</td>
                    <td class="editable" data-diameter="16.00">-</td>
                    <td class="editable" data-diameter="18.00">-</td>
                    <td class="editable" data-diameter="20.00">-</td>
                    <td class="editable" data-diameter="22.00">-</td>
                    <td class="editable" data-diameter="24.00">-</td>
                </tr>
                <tr class="section-header">
                    <td colspan="12">Corrosion Rate</td>
                </tr>
                <tr class="short-term-corrosion-rate">
                    <td>Short Term Corrosion Rate (mm/year)</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr class="long-term-corrosion-rate">
                    <td>Long Term Corrosion Rate (mm/year)</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr class="section-header">
                    <td colspan="12">Minimum</td>
                </tr>
                <tr>
                    <td>Structural Tmin (mm)</td>
                    <td>2.50</td>
                    <td>3.50</td>
                    <td>3.50</td>
                    <td>4.00</td>
                    <td>4.50</td>
                    <td>5.00</td>
                    <td>5.00</td>
                    <td>5.00</td>
                    <td>6.00</td>
                    <td>0.00</td>
                    <td>6.50</td>
                </tr>
                <tr>
                    <td>31.3 Tmin (mm)</td>
                    <td>2.19</td>
                    <td>5.19</td>
                    <td>7.64</td>
                    <td>12.39</td>
                    <td>14.70</td>
                    <td>16.14</td>
                    <td>18.45</td>
                    <td>20.75</td>
                    <td>23.06</td>
                    <td>25.36</td>
                    <td>27.67</td>
                </tr>
                <tr class="anomaly-criteria">
                    <td>Anomaly Criteria</td>
                    <td>4.82</td>
                    <td>8.16</td>
                    <td>10.95</td>
                    <td>15.33</td>
                    <td>18.07</td>
                    <td>19.98</td>
                    <td>22.32</td>
                    <td>25.06</td>
                    <td>27.80</td>
                    <td>30.14</td>
                    <td>33.28</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="modal-readings" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal-readings')">×</span>
            <h3>Enter Readings for All Test Points and Welds</h3>
            <div class="modal-tabs">
                <button class="tab-button active" onclick="showTab('test-points')">Test Points</button>
                <button class="tab-button" onclick="showTab('welds')">Welds</button>
            </div>

            <div id="test-points" class="tab-content active">
                <h4>Test Points (TP1 - TP33)</h4>
                <div class="grid">
                    <div><label>TP1:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP2:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP3:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP4:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP5:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP6:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP7:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP8:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP9:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP10:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP11:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP12:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP13:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP14:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP15:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP16:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP17:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP18:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP19:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP20:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP21:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP22:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP23:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP24:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP25:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP26:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP27:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP28:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP29:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP30:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP31:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP32:</label><input type="text" class="maximo-input"></div>
                    <div><label>TP33:</label><input type="text" class="maximo-input"></div>
                </div>
            </div>

            <div id="welds" class="tab-content">
                <h4>Welds (W1 - W40)</h4>
                <div class="grid">
                    <div><label>W1:</label><input type="text" class="maximo-input"></div>
                    <div><label>W2:</label><input type="text" class="maximo-input"></div>
                    <div><label>W3:</label><input type="text" class="maximo-input"></div>
                    <div><label>W4:</label><input type="text" class="maximo-input"></div>
                    <div><label>W5:</label><input type="text" class="maximo-input"></div>
                    <div><label>W6:</label><input type="text" class="maximo-input"></div>
                    <div><label>W7:</label><input type="text" class="maximo-input"></div>
                    <div><label>W8:</label><input type="text" class="maximo-input"></div>
                    <div><label>W9:</label><input type="text" class="maximo-input"></div>
                    <div><label>W10:</label><input type="text" class="maximo-input"></div>
                    <div><label>W11:</label><input type="text" class="maximo-input"></div>
                    <div><label>W12:</label><input type="text" class="maximo-input"></div>
                    <div><label>W13:</label><input type="text" class="maximo-input"></div>
                    <div><label>W14:</label><input type="text" class="maximo-input"></div>
                    <div><label>W15:</label><input type="text" class="maximo-input"></div>
                    <div><label>W16:</label><input type="text" class="maximo-input"></div>
                    <div><label>W17:</label><input type="text" class="maximo-input"></div>
                    <div><label>W18:</label><input type="text" class="maximo-input"></div>
                    <div><label>W19:</label><input type="text" class="maximo-input"></div>
                    <div><label>W20:</label><input type="text" class="maximo-input"></div>
                    <div><label>W21:</label><input type="text" class="maximo-input"></div>
                    <div><label>W22:</label><input type="text" class="maximo-input"></div>
                    <div><label>W23:</label><input type="text" class="maximo-input"></div>
                    <div><label>W24:</label><input type="text" class="maximo-input"></div>
                    <div><label>W25:</label><input type="text" class="maximo-input"></div>
                    <div><label>W26:</label><input type="text" class="maximo-input"></div>
                    <div><label>W27:</label><input type="text" class="maximo-input"></div>
                    <div><label>W28:</label><input type="text" class="maximo-input"></div>
                    <div><label>W29:</label><input type="text" class="maximo-input"></div>
                    <div><label>W30:</label><input type="text" class="maximo-input"></div>
                    <div><label>W31:</label><input type="text" class="maximo-input"></div>
                    <div><label>W32:</label><input type="text" class="maximo-input"></div>
                    <div><label>W33:</label><input type="text" class="maximo-input"></div>
                    <div><label>W34:</label><input type="text" class="maximo-input"></div>
                    <div><label>W35:</label><input type="text" class="maximo-input"></div>
                    <div><label>W36:</label><input type="text" class="maximo-input"></div>
                    <div><label>W37:</label><input type="text" class="maximo-input"></div>
                    <div><label>W38:</label><input type="text" class="maximo-input"></div>
                    <div><label>W39:</label><input type="text" class="maximo-input"></div>
                    <div><label>W40:</label><input type="text" class="maximo-input"></div>
                </div>
            </div>

            <button class="maximo-button save-button button-spacing" onclick="saveReadings()">Save All Readings</button>
        </div>
    </div>

    <div id="modal-add-row" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal-add-row')">×</span>
            <h3>Select Date for New Measurement Row</h3>
            <div class="grid">
                <div>
                    <label>Date:</label>
                    <input type="date" id="new-row-date" class="maximo-input">
                </div>
            </div>
            <button class="maximo-button button-spacing" onclick="addRow()">Add Row</button>
        </div>
    </div>

    <div id="modal-compare" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal-compare')">×</span>
            <h3>All Readings Across Years</h3>
            <div class="modal-tabs">
                <button class="tab-button active" onclick="showCompareTab('compare-test-points')">Test Points</button>
                <button class="tab-button" onclick="showCompareTab('compare-welds')">Welds</button>
                <button class="tab-button" onclick="showCompareTab('compare-corrosion-rates')">Corrosion Rates</button>
            </div>
            <div id="compare-test-points" class="tab-content active">
                <h4>Test Points</h4>
                <div class="compare-table-scroll">
                    <table id="compare-table-test-points">
                        <thead>
                            <tr>
                                <th>Test Point</th>
                                <!-- Years will be dynamically added -->
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="compare-welds" class="tab-content">
                <h4>Welds</h4>
                <div class="compare-table-scroll">
                    <table id="compare-table-welds">
                        <thead>
                            <tr>
                                <th>Weld</th>
                                <!-- Years will be dynamically added -->
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="compare-corrosion-rates" class="tab-content">
                <h4>Corrosion Rates</h4>
                <div class="compare-table-scroll">
                    <table id="compare-table-corrosion-rates">
                        <thead>
                            <tr>
                                <th>Diameter (inches)</th>
                                <th>Type</th>
                                <th>Rate (mm/year)</th>
                                <th>Formula</th>
                                <th>Readings Used</th>
                                <th>Time Difference</th>
                                <th>Calculation</th>
                                <th>Dates</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-edit-reading" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal-edit-reading')">×</span>
            <h3>Edit Reading</h3>
            <div class="grid">
                <div>
                    <label>Year:</label>
                    <input type="text" id="edit-year" class="maximo-input" readonly>
                </div>
                <div>
                    <label>Minimum Reading (mm):</label>
                    <input type="text" id="edit-reading-value" class="maximo-input">
                </div>
                <div>
                    <label>Test Point/Weld:</label>
                    <select id="edit-test-point" class="maximo-input">
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label>Add New Test Point/Weld:</label>
                    <input type="text" id="new-test-point-weld" class="maximo-input" placeholder="e.g., TP34 or W41">
                    <button class="maximo-button button-spacing" onclick="addNewTestPointWeld()">Add to List</button>
                </div>
                <div>
                    <label>Comment:</label>
                    <input type="text" id="edit-comment" class="maximo-input" placeholder="Add a comment">
                </div>
            </div>
            <button class="maximo-button button-spacing" onclick="saveEditedReading()">Save Reading</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let currentCell = null;
        let currentTestPoint = null; // Store the test point/weld separately to avoid DOM issues
        let currentYear = null; // Store the year when editing from Compare Readings
        let currentDiameter = null; // Store the diameter when editing from Compare Readings
        let isCompareReadingEdit = false; // Flag to indicate if we're editing from Compare Readings
        let comments = {
            "TP1": "Spot reading only",
            "W1": "Slight internal loss",
            "TP2": "Spot reading only",
            "TP3": "Slight internal loss",
            "W2": "Spot reading only",
            "TP4": "Slight internal loss"
        }; // Updated to store one comment per test point/weld
        let testPoints = Array.from({ length: 33 }, (_, i) => `TP${i + 1}`);
        let welds = Array.from({ length: 40 }, (_, i) => `W${i + 1}`);
        const diameterMapping = {
            "1.50": 1,
            "4.00": 2,
            "6.00": 3,
            "10.00": 4,
            "12.00": 5,
            "14.00": 6,
            "16.00": 7,
            "18.00": 8,
            "20.00": 9,
            "22.00": 10,
            "24.00": 11
        };
        let corrosionRateCalculations = []; // Store calculations for the new tab
        const diameters = ['1.50', '4.00', '6.00', '10.00', '12.00', '14.00', '16.00', '18.00', '20.00', '22.00', '24.00'];

        // Data structure to store all readings
        let readingsData = {};

        function attachEditableListeners() {
            const editableCells = document.querySelectorAll('.editable');
            editableCells.forEach(cell => {
                // Remove existing listeners to prevent duplicates
                cell.removeEventListener('click', openEditReadingModal);
                cell.addEventListener('click', () => openEditReadingModal(cell));
            });

            const editableCompareCells = document.querySelectorAll('.editable-compare');
            editableCompareCells.forEach(cell => {
                cell.removeEventListener('click', openEditReadingModalFromCompare);
                cell.addEventListener('click', () => openEditReadingModalFromCompare(cell));
            });
        }

        function populateTestPointWeldDropdown() {
            const select = document.getElementById('edit-test-point');
            if (!select) return; // Exit if element is not found
            select.innerHTML = ''; // Clear existing options
            testPoints.forEach(tp => {
                const option = document.createElement('option');
                option.value = tp;
                option.textContent = tp;
                select.appendChild(option);
            });
            welds.forEach(weld => {
                const option = document.createElement('option');
                option.value = weld;
                option.textContent = weld;
                select.appendChild(option);
            });
        }

        function addNewTestPointWeld() {
            const newValue = document.getElementById('new-test-point-weld').value.trim();
            if (newValue) {
                if (newValue.startsWith('TP') && !testPoints.includes(newValue)) {
                    testPoints.push(newValue);
                } else if (newValue.startsWith('W') && !welds.includes(newValue)) {
                    welds.push(newValue);
                } else {
                    alert('Invalid or duplicate Test Point/Weld. Please use format TP# or W# and ensure it is unique.');
                    return;
                }
                populateTestPointWeldDropdown();
                document.getElementById('new-test-point-weld').value = ''; // Clear the input
                document.getElementById('edit-test-point').value = newValue; // Select the newly added value
            } else {
                alert('Please enter a Test Point or Weld (e.g., TP34 or W41).');
            }
        }

        function openAddRowModal() {
            const dateInput = document.getElementById('new-row-date');
            // Set default date to today's date (2025-05-18)
            dateInput.value = '2025-05-18';
            // Close the Edit Reading modal if it's open to prevent stale currentCell references
            closeModal('modal-edit-reading');
            currentCell = null; // Reset currentCell
            currentTestPoint = null; // Reset currentTestPoint
            document.getElementById('modal-add-row').style.display = 'block';
        }

        function openCompareModal(tabId = 'compare-test-points') {
            // Close the Edit Reading modal if it's open to prevent stale currentCell references
            closeModal('modal-edit-reading');
            currentCell = null; // Reset currentCell
            currentTestPoint = null; // Reset currentTestPoint
            document.getElementById('modal-compare').style.display = 'block';
            // Simulate clicking the appropriate tab button
            const tabButton = document.querySelector(`#modal-compare .tab-button[onclick="showCompareTab('${tabId}')"]`);
            if (tabButton) {
                tabButton.click();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log(`Closing modal: ${modalId}`); // Debug log to confirm closure
                modal.style.display = 'none';
            }
            // Reset currentCell and currentTestPoint when closing the Edit Reading modal
            if (modalId === 'modal-edit-reading') {
                currentCell = null;
                currentTestPoint = null;
                currentYear = null;
                currentDiameter = null;
                isCompareReadingEdit = false;
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function showCompareTab(tabId) {
            document.querySelectorAll('#modal-compare .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('#modal-compare .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            if (tabId === 'compare-test-points') {
                compareReadings(); // Refresh Test Points tab
            } else if (tabId === 'compare-welds') {
                compareReadings(); // Refresh Welds tab
            } else if (tabId === 'compare-corrosion-rates') {
                displayCorrosionRates(); // Populate Corrosion Rates tab
            }
        }

        function addRow() {
            const date = document.getElementById('new-row-date').value;
            if (date) {
                const table = document.querySelector('table tbody');
                const newRow = document.createElement('tr');
                const dateCell = document.createElement('td');
                const formattedDate = new Date(date).toLocaleDateString('en-GB');
                dateCell.textContent = formattedDate;
                newRow.appendChild(dateCell);

                // Initialize readingsData for the new year
                if (!readingsData[formattedDate]) {
                    readingsData[formattedDate] = {};
                    diameters.forEach(diameter => {
                        readingsData[formattedDate][diameter] = [];
                    });
                }

                // Add editable cells with data-diameter attributes
                diameters.forEach(diameter => {
                    const cell = document.createElement('td');
                    cell.className = 'editable';
                    cell.setAttribute('data-diameter', diameter);
                    cell.textContent = '-';
                    newRow.appendChild(cell);
                });

                // Collect all rows to find the "Measurements" section
                const rows = table.querySelectorAll('tr');
                let measurementsSectionStart = -1;
                let measurementsSectionEnd = -1;
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const firstCell = row.querySelector('td');
                    if (firstCell && firstCell.textContent === 'Measurements') {
                        measurementsSectionStart = i;
                    } else if (firstCell && firstCell.textContent === 'Corrosion Rate') {
                        measurementsSectionEnd = i - 1;
                        break;
                    }
                }

                // If measurementsSectionEnd is not set (e.g., no "Corrosion Rate" section yet), set it to the last row
                if (measurementsSectionEnd === -1) {
                    measurementsSectionEnd = rows.length - 1;
                }

                // Insert the new row at the end of the Measurements section
                table.insertBefore(newRow, rows[measurementsSectionEnd + 1]);

                // Add event listeners to the new row's editable cells
                const newCells = newRow.querySelectorAll('.editable');
                newCells.forEach(cell => {
                    cell.addEventListener('click', () => openEditReadingModal(cell));
                    updateCellColor(cell);
                });

                closeModal('modal-add-row');
                updateCorrosionRates();
                compareReadings();
            } else {
                alert('Please select a date.');
            }
        }

        function saveReadings() {
            alert('Readings saved!');
            closeModal('modal-readings');
        }

        function calculateTimeDifference(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr.split('/').reverse().join('-'));
            const endDate = new Date(endDateStr.split('/').reverse().join('-'));
            const timeDiff = endDate - startDate;
            const yearsDiff = timeDiff / (1000 * 60 * 60 * 24 * 365.25);
            return yearsDiff;
        }

        function updateCellColor(cell) {
            if (!cell) return; // Exit if cell is invalid

            const diameter = cell.getAttribute('data-diameter');
            console.log(`updateCellColor: diameter=${diameter}`); // Debug log

            const anomalyRow = document.querySelector('.anomaly-criteria');
            const diameters = ['1.50', '4.00', '6.00', '10.00', '12.00', '14.00', '16.00', '18.00', '20.00', '22.00', '24.00'];
            const index = diameters.indexOf(diameter);
            console.log(`updateCellColor: index=${index}`); // Debug log

            // Check if diameter is valid and index is within bounds
            if (index === -1 || !anomalyRow || !anomalyRow.cells || !anomalyRow.cells[index + 1]) {
                console.log('updateCellColor: Invalid diameter or anomaly row/cell not found; skipping color update.');
                return;
            }

            const anomalyCriteria = parseFloat(anomalyRow.cells[index + 1].textContent);
            const readingMatch = cell.textContent.match(/Min: ([\d.]+) mm/);
            const reading = readingMatch ? parseFloat(readingMatch[1]) : null;
            console.log(`updateCellColor: anomalyCriteria=${anomalyCriteria}, reading=${reading}`); // Debug log

            // Remove existing color classes
            cell.classList.remove('below-nominal-anomaly', 'above-nominal');

            if (reading !== null && !isNaN(anomalyCriteria)) {
                if (reading < anomalyCriteria) {
                    console.log(`updateCellColor: Reading ${reading} < ${anomalyCriteria}, setting below-nominal-anomaly (orange)`);
                    cell.classList.add('below-nominal-anomaly'); // Orange
                } else {
                    console.log(`updateCellColor: Reading ${reading} >= ${anomalyCriteria}, setting above-nominal (green)`);
                    cell.classList.add('above-nominal'); // Green
                }
            } else {
                console.log('updateCellColor: No valid reading or anomaly criteria; skipping color update.');
            }
        }

        function getNominalWallThickness(diameter) {
            const nominalRow = document.querySelector('.nominal-wall-thickness');
            const index = diameterMapping[diameter];
            console.log(`getNominalWallThickness: diameter=${diameter}, index=${index}`); // Debug log

            // Check if nominalRow and its cells exist
            if (!nominalRow || !nominalRow.cells || !nominalRow.cells[index]) {
                console.log('getNominalWallThickness: Nominal wall thickness row or cell not found; returning default value.');
                return '-';
            }

            const nominalThickness = nominalRow.cells[index].textContent;
            console.log(`getNominalWallThickness: nominalThickness=${nominalThickness}`); // Debug log
            return nominalThickness;
        }

        function updateMainTable() {
            const table = document.querySelector('table tbody');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            let measurementsSectionStart = -1;
            let measurementsSectionEnd = -1;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const firstCell = row.querySelector('td');
                if (firstCell && firstCell.textContent === 'Measurements') {
                    measurementsSectionStart = i;
                } else if (firstCell && firstCell.textContent === 'Corrosion Rate') {
                    measurementsSectionEnd = i - 1;
                    break;
                }
            }

            if (measurementsSectionStart === -1 || measurementsSectionEnd === -1) return;

            // Update each measurement row in the main table
            for (let i = measurementsSectionStart + 1; i <= measurementsSectionEnd; i++) {
                const row = rows[i];
                const year = row.cells[0].textContent;
                if (!readingsData[year]) continue;

                for (let j = 1; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    const diameter = cell.getAttribute('data-diameter');
                    const readings = readingsData[year][diameter] || [];

                    if (readings.length === 0) {
                        cell.innerHTML = '-';
                        cell.removeAttribute('data-test-point');
                    } else {
                        // Find the lowest reading
                        const lowest = readings.reduce((min, r) => r.reading < min.reading ? r : min, readings[0]);
                        cell.innerHTML = `Min: ${lowest.reading.toFixed(2)} mm<br>${lowest.testPoint}`;
                        cell.setAttribute('data-test-point', lowest.testPoint);
                        cell.setAttribute('data-diameter', diameter); // Ensure data-diameter is preserved
                        updateCellColor(cell);
                    }
                }
            }

            // Reattach event listeners
            attachEditableListeners();
        }

        function updateCorrosionRates() {
            const table = document.querySelector('table tbody');
            if (!table) {
                console.log('Table body not found; skipping corrosion rate update.');
                return;
            }

            const rows = table.querySelectorAll('tr');
            const shortTermRow = document.querySelector('.short-term-corrosion-rate');
            const longTermRow = document.querySelector('.long-term-corrosion-rate');
            const diameters = ['1.50', '4.00', '6.00', '10.00', '12.00', '14.00', '16.00', '18.00', '20.00', '22.00', '24.00'];

            if (!shortTermRow || !longTermRow) {
                console.log('Corrosion rate rows not found; skipping update.');
                return;
            }

            // Clear previous calculations
            corrosionRateCalculations = [];

            // Initialize corrosion rate cells to "-"
            for (let i = 1; i < shortTermRow.cells.length; i++) {
                shortTermRow.cells[i].innerHTML = '-';
                longTermRow.cells[i].innerHTML = '-';
            }

            // Collect all measurement rows
            const measurementRows = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0 && cells[0].textContent.match(/\d{2}\/\d{2}\/\d{4}/)) {
                    measurementRows.push(row);
                }
            });

            // Sort measurement rows by date (ascending)
            measurementRows.sort((a, b) => {
                const dateA = new Date(a.cells[0].textContent.split('/').reverse().join('-'));
                const dateB = new Date(b.cells[0].textContent.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            // Calculate corrosion rates for each diameter
            diameters.forEach((diameter, index) => {
                const readings = [];
                measurementRows.forEach(row => {
                    const year = row.cells[0].textContent;
                    const yearReadings = readingsData[year][diameter] || [];
                    yearReadings.forEach(readingEntry => {
                        readings.push({ date: year, reading: readingEntry.reading });
                    });
                });

                // Need at least 2 readings to calculate corrosion rates
                if (readings.length >= 2) {
                    // Short Term Corrosion Rate (last two readings)
                    const lastTwo = readings.slice(-2);
                    const shortTermTimeDiff = calculateTimeDifference(lastTwo[0].date, lastTwo[1].date);
                    if (shortTermTimeDiff > 0) { // Ensure time difference is positive
                        const shortTermRate = (lastTwo[0].reading - lastTwo[1].reading) / shortTermTimeDiff;
                        const shortTermCell = shortTermRow.cells[index + 1];
                        shortTermCell.innerHTML = shortTermRate.toFixed(2);
                        corrosionRateCalculations.push({
                            diameter,
                            type: 'Short Term',
                            rate: shortTermRate.toFixed(2),
                            formula: 'ST = (previous - tactual) / time (years)', // Updated formula
                            readings: `(${lastTwo[0].reading} mm - ${lastTwo[1].reading} mm)`,
                            timeDiff: `${shortTermTimeDiff.toFixed(2)} years`,
                            calculation: `${(lastTwo[0].reading - lastTwo[1].reading).toFixed(2)} mm / ${shortTermTimeDiff.toFixed(2)} years`,
                            dates: `${lastTwo[0].date} to ${lastTwo[1].date}`
                        });
                    }

                    // Long Term Corrosion Rate (earliest to latest)
                    const firstLast = [readings[0], readings[readings.length - 1]];
                    const longTermTimeDiff = calculateTimeDifference(firstLast[0].date, firstLast[1].date);
                    if (longTermTimeDiff > 0) { // Ensure time difference is positive
                        const longTermRate = (firstLast[0].reading - firstLast[1].reading) / longTermTimeDiff;
                        const longTermCell = longTermRow.cells[index + 1];
                        longTermCell.innerHTML = longTermRate.toFixed(2);
                        corrosionRateCalculations.push({
                            diameter,
                            type: 'Long Term',
                            rate: longTermRate.toFixed(2),
                            formula: 'LT = (tinitial - tactual) / time (years)',
                            readings: `(${firstLast[0].reading} mm - ${firstLast[1].reading} mm)`,
                            timeDiff: `${longTermTimeDiff.toFixed(2)} years`,
                            calculation: `${(firstLast[0].reading - firstLast[1].reading).toFixed(2)} mm / ${longTermTimeDiff.toFixed(2)} years`,
                            dates: `${firstLast[0].date} to ${firstLast[1].date}`
                        });
                    }
                }
            });

            // Reattach event listeners to editable cells after DOM updates
            attachEditableListeners();
            // Reset currentCell after DOM update to prevent stale references
            currentCell = null;
            currentTestPoint = null;
        }

        function displayCorrosionRates() {
            const tableBody = document.getElementById('compare-table-corrosion-rates').querySelector('tbody');
            tableBody.innerHTML = ''; // Clear previous content

            corrosionRateCalculations.forEach(calc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${calc.diameter}</td>
                    <td>${calc.type}</td>
                    <td>${calc.rate}</td>
                    <td>${calc.formula}</td>
                    <td>${calc.readings}</td>
                    <td>${calc.timeDiff}</td>
                    <td>${calc.calculation}</td>
                    <td>${calc.dates}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function compareReadings() {
            const table = document.querySelector('table');
            if (!table) {
                console.log('Table not found; skipping compare readings.');
                return;
            }

            const rows = table.querySelectorAll('tr');
            const measurementRows = [];

            // Collect all measurement rows
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0 && cells[0].textContent.match(/\d{2}\/\d{2}\/\d{4}/)) {
                    measurementRows.push(row);
                }
            });

            // Sort measurement rows by date (ascending)
            measurementRows.sort((a, b) => {
                const dateA = new Date(a.cells[0].textContent.split('/').reverse().join('-'));
                const dateB = new Date(b.cells[0].textContent.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            // Get all unique years
            const years = measurementRows.map(row => row.cells[0].textContent);

            // Update Test Points tab
            const testPointsTable = document.getElementById('compare-table-test-points');
            const testPointsHead = testPointsTable.querySelector('thead tr');
            const testPointsBody = testPointsTable.querySelector('tbody');
            
            // Clear existing headers and body
            testPointsHead.innerHTML = '<th>Test Point</th>';
            testPointsBody.innerHTML = '';

            // Add year columns dynamically
            years.forEach(year => {
                const th = document.createElement('th');
                th.textContent = year;
                testPointsHead.appendChild(th);
            });
            testPointsHead.innerHTML += '<th>Comment</th>';

            // Populate rows for each test point
            testPoints.forEach(tp => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${tp}</td>`;

                // Add readings for each year
                years.forEach(year => {
                    const readingsForTp = [];
                    diameters.forEach(diameter => {
                        const yearReadings = readingsData[year][diameter] || [];
                        yearReadings.forEach(readingEntry => {
                            if (readingEntry.testPoint === tp) {
                                readingsForTp.push({ ...readingEntry, diameter });
                            }
                        });
                    });

                    if (readingsForTp.length === 0) {
                        // Empty cell, make it editable
                        row.innerHTML += `<td class="editable-compare" data-year="${year}" data-entity="testPoint" data-entity-value="${tp}">-</td>`;
                    } else {
                        // Display all readings for this test point and year
                        const readingsHtml = readingsForTp.map(r => `${r.reading.toFixed(2)} mm<br><span style="color: #3B82F6; font-size: 12px;">Nominal: ${getNominalWallThickness(r.diameter)} mm</span>`).join('<br>');
                        row.innerHTML += `<td>${readingsHtml}</td>`;
                    }
                });

                const commentKey = tp;
                const comment = comments[commentKey] || '';
                row.innerHTML += `
                    <td><input type="text" class="comment-input" data-key="${commentKey}" value="${comment}" placeholder="Add comment"></td>
                `;
                testPointsBody.appendChild(row);
            });

            // Update Welds tab
            const weldsTable = document.getElementById('compare-table-welds');
            const weldsHead = weldsTable.querySelector('thead tr');
            const weldsBody = weldsTable.querySelector('tbody');

            // Clear existing headers and body
            weldsHead.innerHTML = '<th>Weld</th>';
            weldsBody.innerHTML = '';

            // Add year columns dynamically
            years.forEach(year => {
                const th = document.createElement('th');
                th.textContent = year;
                weldsHead.appendChild(th);
            });
            weldsHead.innerHTML += '<th>Comment</th>';

            // Populate rows for each weld
            welds.forEach(weld => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${weld}</td>`;

                // Add readings for each year
                years.forEach(year => {
                    const readingsForWeld = [];
                    diameters.forEach(diameter => {
                        const yearReadings = readingsData[year][diameter] || [];
                        yearReadings.forEach(readingEntry => {
                            if (readingEntry.testPoint === weld) {
                                readingsForWeld.push({ ...readingEntry, diameter });
                            }
                        });
                    });

                    if (readingsForWeld.length === 0) {
                        // Empty cell, make it editable
                        row.innerHTML += `<td class="editable-compare" data-year="${year}" data-entity="weld" data-entity-value="${weld}">-</td>`;
                    } else {
                        // Display all readings for this weld and year
                        const readingsHtml = readingsForWeld.map(r => `${r.reading.toFixed(2)} mm<br><span style="color: #3B82F6; font-size: 12px;">Nominal: ${getNominalWallThickness(r.diameter)} mm</span>`).join('<br>');
                        row.innerHTML += `<td>${readingsHtml}</td>`;
                    }
                });

                const commentKey = weld;
                const comment = comments[commentKey] || '';
                row.innerHTML += `
                    <td><input type="text" class="comment-input" data-key="${commentKey}" value="${comment}" placeholder="Add comment"></td>
                `;
                weldsBody.appendChild(row);
            });

            // Add event listeners to comment inputs and editable cells in both tabs
            attachEditableListeners();
        }

        function openEditReadingModalFromCompare(cell) {
            isCompareReadingEdit = true;
            currentYear = cell.getAttribute('data-year');
            const entity = cell.getAttribute('data-entity');
            const entityValue = cell.getAttribute('data-entity-value');
            currentTestPoint = entityValue;

            // Find the diameter by mapping the column index
            const columnIndex = Array.from(cell.parentElement.children).indexOf(cell);
            currentDiameter = diameters[columnIndex - 1]; // -1 because first column is the label

            console.log(`openEditReadingModalFromCompare: year=${currentYear}, entity=${entity}, entityValue=${entityValue}, diameter=${currentDiameter}`);

            // Open the Edit Reading modal
            document.getElementById('edit-year').value = currentYear;
            document.getElementById('edit-reading-value').value = ''; // Empty since it's a new reading
            populateTestPointWeldDropdown();
            document.getElementById('edit-test-point').value = entityValue;
            document.getElementById('edit-test-point').disabled = true; // Disable changing the test point/weld
            const commentKey = entityValue;
            const comment = comments[commentKey] || '';
            document.getElementById('edit-comment').value = comment;
            document.getElementById('modal-edit-reading').style.display = 'block';
        }

        function handleCommentInput(event) {
            const key = event.target.getAttribute('data-key');
            comments[key] = event.target.value;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const table = document.querySelector('table tbody');
            const rows = table.querySelectorAll('tr');
            let measurementsSectionStart = -1;
            let measurementsSectionEnd = -1;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const firstCell = row.querySelector('td');
                if (firstCell && firstCell.textContent === 'Measurements') {
                    measurementsSectionStart = i;
                } else if (firstCell && firstCell.textContent === 'Corrosion Rate') {
                    measurementsSectionEnd = i - 1;
                    break;
                }
            }

            // Initialize readingsData from existing table
            for (let i = measurementsSectionStart + 1; i <= measurementsSectionEnd; i++) {
                const row = rows[i];
                const year = row.cells[0].textContent;
                readingsData[year] = {};
                diameters.forEach(diameter => {
                    readingsData[year][diameter] = [];
                });

                for (let j = 1; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    const diameter = cell.getAttribute('data-diameter');
                    const readingMatch = cell.textContent.match(/Min: ([\d.]+) mm/);
                    const testPoint = cell.getAttribute('data-test-point');
                    if (readingMatch && testPoint) {
                        const reading = parseFloat(readingMatch[1]);
                        readingsData[year][diameter].push({ reading, testPoint });
                    }
                }
            }

            const editableCells = document.querySelectorAll('.editable');
            editableCells.forEach(cell => {
                cell.addEventListener('click', () => openEditReadingModal(cell));
                updateCellColor(cell); // Initial coloring on page load
            });

            // Initial calculation of corrosion rates
            updateCorrosionRates();
        });

        function openEditReadingModal(cell) {
            isCompareReadingEdit = false;
            currentCell = cell;
            const currentText = cell.textContent;
            const readingMatch = currentText.match(/Min: ([\d.]+) mm/);
            const testPointMatch = currentText.match(/<br>(TP\d+|W\d+)/);
            const testPoint = testPointMatch ? testPointMatch[1] : 'TP1';
            currentTestPoint = testPoint; // Store the test point separately
            const commentKey = testPoint;
            const comment = comments[commentKey] || '';

            // Set the year field
            const row = cell.parentElement;
            const year = row.cells[0].textContent;
            document.getElementById('edit-year').value = year;

            document.getElementById('edit-reading-value').value = readingMatch ? readingMatch[1] : '';
            populateTestPointWeldDropdown();
            document.getElementById('edit-test-point').value = testPoint;
            document.getElementById('edit-test-point').disabled = false; // Allow changing test point in main table
            document.getElementById('edit-comment').value = comment;
            document.getElementById('modal-edit-reading').style.display = 'block';
        }

        function saveEditedReading() {
            const reading = document.getElementById('edit-reading-value').value;
            const testPoint = document.getElementById('edit-test-point').value;
            const comment = document.getElementById('edit-comment').value;

            // Validate inputs before proceeding
            // Skip testPoint validation when editing from Compare Readings since it's pre-set
            if (!reading || (!isCompareReadingEdit && !testPoint)) {
                alert('Please enter a reading' + (!isCompareReadingEdit ? ' and select a test point or weld.' : '.'));
                closeModal('modal-edit-reading');
                return;
            }

            try {
                const parsedReading = parseFloat(reading);
                if (isNaN(parsedReading)) {
                    throw new Error('Reading must be a valid number.');
                }

                if (isCompareReadingEdit) {
                    // Save new reading from Compare Readings modal
                    if (!readingsData[currentYear][currentDiameter]) {
                        readingsData[currentYear][currentDiameter] = [];
                    }
                    readingsData[currentYear][currentDiameter].push({
                        reading: parsedReading,
                        testPoint: testPoint
                    });
                    console.log(`saveEditedReading: Added new reading to readingsData[${currentYear}][${currentDiameter}]: ${parsedReading} mm, ${testPoint}`);
                } else {
                    // Save reading from main table
                    if (!currentCell) {
                        console.log('currentCell is invalid; closing modal without saving.');
                        closeModal('modal-edit-reading');
                        return;
                    }

                    const diameter = currentCell.getAttribute('data-diameter');
                    const row = currentCell.parentElement;
                    const year = row.cells[0].textContent;

                    // Find the existing reading in readingsData and replace it
                    const readings = readingsData[year][diameter];
                    const existingIndex = readings.findIndex(r => r.testPoint === currentTestPoint);
                    if (existingIndex !== -1) {
                        readings.splice(existingIndex, 1); // Remove the old reading
                    }
                    readings.push({ reading: parsedReading, testPoint: testPoint });
                    console.log(`saveEditedReading: Updated readingsData[${year}][${diameter}]: ${parsedReading} mm, ${testPoint}`);

                    // Update the cell content (will be overridden by updateMainTable)
                    currentCell.innerHTML = `Min: ${parsedReading.toFixed(2)} mm<br>${testPoint}`;
                    currentCell.classList.add('filled');
                    currentCell.setAttribute('data-test-point', testPoint);
                    currentCell.setAttribute('data-diameter', diameter); // Ensure data-diameter is preserved
                }

                // Save the comment using the test point (single comment per test point/weld)
                const commentKey = testPoint;
                comments[commentKey] = comment;

                // Update UI and close modal
                updateMainTable();
                updateCorrosionRates();
                compareReadings();
                closeModal('modal-edit-reading');
            } catch (error) {
                alert(error.message);
                closeModal('modal-edit-reading');
            }
        }
    </script>
</body>
</html>
